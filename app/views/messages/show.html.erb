<nav>
<%
  last=@path.last	
  @path.each do |message| %>
  <%= link_to message.title,message if @current_user.can_view? message %><%= ' > ' if message!=last%>
<% end %>
</nav>
<div style="clear:both;"></div>
<% @messages.each do |message| %>
<article>
  <header>
    <a id="<%= message.id%>"/><%= link_to message.title, message %><%= l message.created_at, :format=>:long %>
  </header>
  <aside class="like" title="<%= message.total_likes %>"><%= num_reduce message.total_likes %></aside>
  <% unless @current_user.guest %>
  <nav class='nav'>
    <% if message.deletable? and message.owner? @current_user %>
      <%= link_to 'Edit', edit_message_path(message) if @current_user.can_update? message and message.deletable? %>
      <%= link_to 'Destroy', message, confirm: 'Are you sure?', method: :delete if @current_user.can_destroy? message and message.deletable? %>
    <% end %>
    <%= link_to 'Replay', new_message_path({:id=>message.id}) if @current_user.can_create? message %>
    <%= render :partial=>'likes/form', :locals=>{:message=>message,:current_user=>@current_user} %>
  </nav>
  <% end %>
  <% unless message.poll.nil? %>
    <%= render :partial=>'polls/show', :locals=>{:poll => message.poll, :current_user=>@current_user} %>
  <% end %>
  <section>
    <%= bb message.text %>
    <p class="sign">
      <%= bb message.user.sign unless message.user.sign.nil? %>
    </p>
  </section>
  <aside class="user">
    <%= render :partial=>'users/badge', :locals=>{:user=>message.user} %>
  </aside>
  <nav class="leaf">
    <a href="#top" title="top" class="top">&thinsp;</a>
    <% message.childs(@current_user).each_with_index do |son,i| %>
      <%= link_to "&thinsp;".html_safe, son, :title=> son.user.username+" "+son.created_at.to_formatted_s(:long),:class=>"page" if !@messages.include? son and @current_user.can_view? son %>
    <% end %>
  </nav>
</article>
<% end %>
<%= paginate @messages %>
