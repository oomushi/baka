<% last=@path.last %>
<nav class="menu">
  <%= link_to "&thinsp;".html_safe, @root, confirm: 'Are you sure?', method: :delete,title: "Destroy", class: "button del" if not @root.childs? and @current_user.can_destroy? @root %>
  <%= link_to "&thinsp;".html_safe, edit_message_path(@root),title: "Edit",class: "button edit" if @current_user.can_update? @root %>
  <%= link_to "&thinsp;".html_safe, new_message_path({:id=>last.id}),title: "New message",class: "button add" if @current_user.can_create? @root %>
</nav>
<%= render :partial=>'nav', :locals=>{:path=>@path,:current_user=>@current_user} %>
<table>
  <tr>
    <th>Title</th>
    <th>Last message</th>
    <th></th>
  </tr>

<% @messages.each do |message| %>
    <tr class="link <%= message.pinned ? 'pinned' : '' %>" onclick="location.href='<%= message_path(message) %>'">
    <td class="button clickable <%= message.section ? 'tree' : 'leaf' %>"><h2><%= message.title %></h2><%= message.section ? message.text : '' %></td>
    <td>
	<% if message.section %>
        <% if message.offsprings(@current_user).count.zero? %>
        Nessun messaggio
       <% else  
       last=message.offsprings(@current_user).last %>
       <%= link_to (last.title+"<br/>"+last.created_at.to_formatted_s(:long)).html_safe, last %><br/>
       <%= link_to last.user.username,last.user %><br/>
        <% end %><% end %>
    </td>
    <td><%= link_to "&thinsp;".html_safe, edit_message_path(message),title: "Edit",class: "button edit" if message.section and not message.childs? and @current_user.can_update? message %>
      <%= link_to "&thinsp;".html_safe, message, confirm: 'Are you sure?', method: :delete,title: "Destroy", class: "button del" if message.section and not message.childs? and @current_user.can_destroy? message %></td>
  </tr>
<% end %>
</table>

<%= paginate @messages %>
