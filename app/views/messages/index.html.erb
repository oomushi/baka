<% last=@path.last %>
<%= render :partial=>'nav', :locals=>{:path=>@path,:current_user=>@current_user} %>
<nav>
  <%= link_to 'Edit', edit_message_path(@root) if @current_user.can_update? @root %>
  <%= link_to 'New Message', new_message_path({:id=>last.id}) if @current_user.can_create? @root %>
</nav>
<table>
  <tr>
    <th>Title</th>
    <th>Last message</th>
    <th></th>
    <th></th>
  </tr>

<% @messages.each do |message| %>
    <tr class="link <%= message.pinned ? 'pinned' : '' %>" onclick="location.href='<%= message_path(message) %>'">
    <td class="button clickable <%= message.section ? 'tree' : 'leaf' %>"><h2><%= message.title %></h2><%= message.section ? message.text : '' %></td>
    <td>
	<% if message.section %>
        <% if message.offsprings(@current_user).count.zero? %>
        Nessun messaggio
       <% else  
       last=message.offsprings(@current_user).last %>
       <%= link_to (last.title+"<br/>"+last.created_at.to_formatted_s(:long)).html_safe, last %><br/>
       <%= link_to last.user.username,last.user %><br/>
        <% end %><% end %>
    </td>
    <td><%= link_to 'Edit', edit_message_path(message) if message.section and message.deletable? and @current_user.can_update? message %></td>
    <td><%= link_to 'Destroy', message, confirm: 'Are you sure?', method: :delete if message.section and message.deletable? and @current_user.can_destroy? message %></td>
  </tr>
<% end %>
</table>

<%= paginate @messages %>
